"""
Usage:

    scons
    scons build=release,profile
    scons build=all

    etc.
"""

import os, pickle
from utils import suffix_check, compiler_ver_check, boost_ver_check, lib_check, checkEndian


def save_config(filename, config):
    fd = open(filename, "w")
    pickle.dump(config, fd)
    fd.close()
    
def load_config(filename):
	fd = open(filename, "r")
	config = pickle.load(fd)
	fd.close()
	return config

DEFAUT_TARGET = "release"
ENV_SETPARAMS = ["CXXFLAGS", "CPPDEFINES", "LINKFLAGS", "CPPPATH", "LIBPATH", "CXX", "LIBS"]   
TARGETS = {
    "release":   Environment(
        CXXFLAGS = ["-O6", "-fomit-frame-pointer"], 
        CPPDEFINES = {'DEBUG': 1, 'WITH_STOPPER': 1, 'NO_THRIFT':1, 'NDEBUG': 1}, 
        ),
    "debug":   Environment(
        CXXFLAGS = ["-O0", "-g", "-fkeep-inline-functions", "-fmerge-all-constants"], 
        CPPDEFINES = {'DEBUG': 1, 'WITH_STOPPER': 1, 'NO_THRIFT':1},
        #LINKFLAGS = ["-pg"] 
        ),
    "profile": Environment(
        CXXFLAGS = ["-O6", "-g", "-pg"],
        CPPDEFINES = {'DEBUG': 1, 'NDEBUG': 1, 'WITH_STOPPER': 1},
        LINKFLAGS = ["-pg"]
        ),
}

FRAG_BOOST_LIBS_USED = ['program_options', "system"]
UTIL_BOOST_LIBS_USED = ['date_time', "thread"]
SRC_LIST = [ 'mp4frag_main.cc', 'mp4frag.cc', 'mp4.cc', 'base64.cc' ]

variants = ARGUMENTS.get("build", DEFAUT_TARGET).split(",")
if ARGUMENTS.has_key("lubuild"):
	luvariants = ARGUMENTS["lubuild"]
else:
	luvariants = variants

def frag_build(env, build_dir, prefix, need_install):
	VariantDir(build_dir, ".")
	cur_src_list = [build_dir + "/" + src for src in SRC_LIST]
	mp4frag = env.Program(build_dir + "/mp4frag", cur_src_list )
	env.Alias('install', prefix)
	
	#if len(variants) == 1 or (len(variants) > 1 and key == "release"):
	if need_install:	
		env.Install(prefix, mp4frag)

def util_build(env, build_dir, prefix, need_install):
	libsuffix = "lib"
	builddir = "libutility/" + build_dir
	libbuilddir = os.path.join(builddir, "libsuffix")
	Export('env')
	SConscript("libutility/utility/src/SConscript", variant_dir = libbuilddir)
	#if "examples" in COMMAND_LINE_TARGETS:
	#	SConscript("libutility/examples/SConscript", variant_dir = builddir )
	

def util_extra_init(env, libs_used):
	backend = ARGUMENTS.get("backend", "libevent")
	if backend == "libevent":
		libs_used.append('event'),
		env.Append(CPPDEFINES = {"LIBEVENT_REACTOR": 1})
	else:
		env.Append(CPPDEFINES = {"EPOLL_REACTOR": 1})
	
	env.Append(CPPPATH = "#/libutility")
	env.Append(CXXFLAGS = ['-pipe', '-Werror', '-Wno-deprecated', '-std=c++0x'])


def prepare_boost_libs(env, libs_used):
    libpath = ["/lib", "/usr/lib"]
    if os.getenv("LD_LIBRARY_PATH"):
        libpath.append(os.getenv("LD_LIBRARY_PATH"))
        
    if env.has_key("LIBPATH"):
        libpath.extend(env["LIBPATH"])
        
    suffix_check(libpath, libs_used)

configures = {}

def rename_this_function(variants, config_prefix, subroutines, compiler_ver, boost_libs_used, libs_used):
	need_install = True
	for variant in variants:
		dir = "." + variant
		#if True:
		try:
			assert "configure" not in COMMAND_LINE_TARGETS
			#assert "configure" in COMMAND_LINE_TARGETS
			#load_config(".config" + dir, env)
			dump_config = load_config(config_prefix + dir)
			env = Environment()
			for key in ENV_SETPARAMS:#, val in env.Dictionary().items():
				env[key] = dump_config["env"][key]
			prefix = dump_config["prefix"]
		#if False:
		except:
			print 
			env = TARGETS[variant]
			env.Append(CPPPATH = filter(None, ARGUMENTS.get("includes", "").split(",")))
			env.Append(CPPPATH = "libutility")
			
			env.Append(LIBPATH = filter(None, ARGUMENTS.get("libpath", "").split(",")))
			#env['LIBPATH'] = filter(None, ARGUMENTS.get("libpath", "").split(","))
			env.Append(CPPDEFINES = {'BOOST_SP_USE_QUICK_ALLOCATOR': 1,})
			env.Append(CXXFLAGS = ['-Woverloaded-virtual', '-Wall'])
			env.Append(LIBPATH = '/usr/local/lib')
			
			if "prefix" in ARGUMENTS:
				prefix = ARGUMENTS["prefix"]
			else:
				prefix = "/usr/local/bin"
	    
            
			chk_conf = Configure(env, custom_tests = 
	    		{
	    		 "boost_ver_check" : boost_ver_check, 
	    		 "checkEndian" :  checkEndian, 
	    		 "compiler_ver_check" : compiler_ver_check,
	    		 "lib_check" : lib_check,
	    		}
	    	)
	    	
			#if subroutines.has_key("prepare_boost_libs"):
			#	prepare_boost_libs = subroutines["prepare_boost_libs"] 
			#	prepare_boost_libs(env, boost_libs_used)
			
			if subroutines.has_key("extra_init"):
				extra_init = subroutines["extra_init"]
				extra_init(env, libs_used)
				
			prepare_boost_libs(env, boost_libs_used)
			libs_used.extend(boost_libs_used)
				
			if ARGUMENTS.has_key("compiler"):
				chk_conf.env['CXX'] = ARGUMENTS["compiler"]
			elif os.getenv("CXX"):
				chk_conf.env['CXX'] = os.getenv("CXX")
			else:
				chk_conf.env["CXX"] = "g++"
			
			#print env["CXXVERISON"]
			if not chk_conf.CheckCXX() or not chk_conf.compiler_ver_check(chk_conf.env["CXX"], compiler_ver):
				Exit(1)
	    	
			endian = chk_conf.checkEndian() # look at AC_C_BIGENDIAN on this wiki
			if endian == "little":
				chk_conf.env.Append(CPPDEFINES = {'LITTLE_ENDIAN': 1})	
			elif endian == "big":
				chk_conf.env.Append(CPPDEFINES = {'BIG_ENDIAN': 1})
	     	
			if not chk_conf.boost_ver_check("1.39.0"):
				Exit(1)
			
			if not lib_check(chk_conf, libs_used):
				Exit(1)
				
			chk_conf.env["LIBS"] = libs_used
            
			env = chk_conf.Finish()
			dump_env = {}
			for key in ENV_SETPARAMS:#, val in env.Dictionary().items():
				dump_env[key] = env.Dictionary()[key]
				#print "Types:", type(key)#, ":", type(val) 
				
			save_config(config_prefix + dir, {"env" : dump_env, "prefix" : prefix})
			#print "Configured"
        
		if "printconf" in COMMAND_LINE_TARGETS or "configure" in COMMAND_LINE_TARGETS:
			import pprint
			pprint.pprint(env)
			Exit(0)
     
		build = subroutines["build"]
		configures[config_prefix + variant] = env.Clone()
		build(configures[config_prefix + variant], "." + variant, prefix, need_install) 
		need_install = False

#frag_subroutines = {"prepare_boost_libs" : frag_prepare_boost_libs, "build" : frag_build}
frag_subroutines = {"build" : frag_build}
print "Processing mp4fragmenter"
rename_this_function(variants, ".config", frag_subroutines, "4.1.0", FRAG_BOOST_LIBS_USED, [])

print "Processing libutility"
if os.path.exists("libutility"):
	util_subroutines = {"extra_init" : util_extra_init, "build" : util_build}
	rename_this_function(luvariants, ".luconfig", util_subroutines, "4.3.0", UTIL_BOOST_LIBS_USED, [])

#os.remove("config.log")